# 规则说明（当前实现）

本文档基于现有代码的实际行为汇总，便于审核与对齐。

**基础目标**
玩家与对手各有 10 点生命，生命降到 0 时视为失败（目前仅数值变化，未实现胜负结算界面）。

**回合流程**
1. 玩家回合开始：能量上限 +1（最多 10），当前能量回满。
2. 玩家行动：可以拖拽出牌、攻击或点击牌库抽牌。
3. 玩家结束回合：点击 `End Turn`。
4. 对手回合开始：能量上限 +1（最多 10），当前能量回满。
5. 对手行动：抽 1 张牌、尝试出 1 张可支付的随从、让所有随从攻击一次。
6. 对手结束回合：进入下一玩家回合。

**抽牌**
- 开局双方各抽 5 张（`STARTING_HAND_SIZE = 5`）。
- 玩家每回合只能主动抽 1 张（点击牌库）。
- 对手每回合自动抽 1 张。
- 无手牌上限。

**能量（费用系统）**
- 规则常量：`STARTING_MAX_ENERGY = 0`，`ENERGY_GROWTH = 1`，`MAX_ENERGY = 10`。
- 每回合开始：最大能量 +1（不超过 10），当前能量回满。
- 出牌必须支付费用，不足则无法打出。
- 玩家出牌时即时扣费；对手出牌时即时扣费。

**卡牌类型与槽位**
- 卡牌类型：`Monster`（随从），`Magic`（法术）。
- 槽位类型：随从槽位与法术槽位分开。
- 只能将卡牌放入同类型槽位。

**出牌限制**
- 玩家每回合最多打出 1 张随从。
- 法术不受“每回合 1 张随从”的限制。

**战斗规则**
- 玩家只能在自己回合发起攻击。
- 若对手场上无随从，玩家随从可直接攻击对手英雄。
- 随从攻击流程：
  - 互相造成伤害，生命值降至 0 的随从被摧毁。
  - 每个随从每回合默认只能攻击 1 次（通过攻击记录限制）。
- 对手回合：每个对手随从攻击 1 次，优先随机攻击玩家随从；若无玩家随从则直接攻击玩家英雄。

**能力系统（AbilityBus 事件）**
事件总线对所有场上卡牌分发事件，当前事件包括：
- `on_play`：卡牌被打出后触发。
- `on_attack`：攻击结算后触发（含直接攻击与随从互殴）。
- `on_death`：卡牌被摧毁时触发。
- `turn_start`：回合开始触发。
- `turn_end`：回合结束触发。

事件上下文包含：
- `battle_manager`：战斗管理器引用
- `input_manager`：输入管理器引用
- `source`：触发事件的卡牌
- `card`：当前事件目标卡牌（常为 `source`）
- `turn_owner`：当前回合所属（`Player` 或 `Opponent`）
- 其它可选字段：`attacker`，`target`，能量数据等

**当前能力实现**
- Archer（弓箭手）：`on_play` 对敌方英雄造成 1 点伤害。
- Tornado（龙卷风）：`on_play` 对敌方所有随从造成 1 点伤害，随后自身被摧毁。
- Demon（恶魔）：`on_attack` 触发“可再攻击一次”（本回合仅一次，回合结束重置）。

**卡牌数据来源**
- 卡牌属性从 `Data/cards.json` 读取。
- 主要字段：`type`、`cost`、`attack`、`health`、`ability_script`、`ability_text`。

**规划中（待实现）**
胜负条件与 UI：
触发条件：任一方生命值 ≤ 0 立即结束对局。
疲劳：牌库抽空后每次尝试抽牌会造成疲劳伤害（每次 +1 递增）。
UI 占位：屏幕中央半透明遮罩 + 文本 `Victory` / `Defeat` + 按钮 `Restart`。
技术方案：在 `BattleManager` 每次生命变化后检查；触发后禁用输入，显示 `EndGameOverlay`（文字节点即可）。

手牌上限（上限 5）：
抽牌时若手牌已满：该牌直接丢弃到弃牌堆，不触发 `OnDraw`。

关键词与攻击规则：
召唤疲劳：无 `Charge` 的随从当回合不可攻击。
Taunt：只要场上存在带嘲讽单位，必须以其为攻击目标。
结算顺序（一次攻击）：校验目标（Taunt 优先）→ 伤害同时结算 → 死亡判定 → `Deathrattle` 触发 → `on_attack` 触发 → 清理状态。
OnDraw：成功入手牌后触发（若手满则不触发）。

AbilityBus 触发队列：
维持现有 AbilityBus，增加内部队列避免嵌套触发顺序不确定。
触发顺序建议：主动玩家单位 → 对手单位；场上从左到右（或创建顺序）保证可复现。

UI 文字占位：
`TurnLabel`：`Your Turn` / `Enemy Turn`。
`EndGameLabel`：`Victory` / `Defeat`。
`HandLimitLabel`：`Hand Full`。
暂不做图像，纯文本 + 半透明矩形即可。
